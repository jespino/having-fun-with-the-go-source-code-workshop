<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise 5: gofmt Transformation - &#34;hello&#34; to &#34;helo&#34; - Go Source Code Workshop</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();

            
            document.querySelectorAll('pre').forEach(function(pre) {
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.innerHTML = '<i class="far fa-copy"></i>';
                button.title = 'Copy to clipboard';

                button.addEventListener('click', function() {
                    const code = pre.querySelector('code');
                    const text = code.textContent;

                    navigator.clipboard.writeText(text).then(function() {
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        button.classList.add('copied');
                        setTimeout(function() {
                            button.innerHTML = '<i class="far fa-copy"></i>';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                    });
                });

                pre.appendChild(button);
            });
        });
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="nav-home">üöÄ Having fun with the Go Source Code</a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="https://github.com/jespino/having-fun-with-the-go-source-code-workshop" target="_blank"><i class="fab fa-github"></i> Repository</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <article class="exercise-content">
            <h1>‚ö° Exercise 5: gofmt Modification - Indentation &amp; AST Transformation</h1>

<p>In this exercise, you&rsquo;ll modify Go&rsquo;s formatting tool <code>gofmt</code> to use 4 spaces instead of tabs, and then add a custom AST transformation to automatically replace the word &ldquo;hello&rdquo; with &ldquo;helo&rdquo; in string literals and comments! üîÑ This will teach you how Go&rsquo;s formatter works, how printer modes control indentation, and how to add custom transformations to the AST processing pipeline.</p>

<h2>üéØ Learning Objectives</h2>

<p>By the end of this exercise, you will:</p>

<ul>
<li>‚úÖ Understand how gofmt controls indentation and printer modes</li>
<li>‚úÖ Learn to modify formatting behavior across gofmt and go/format package</li>
<li>‚úÖ Understand how gofmt processes Go source code through AST manipulation</li>
<li>‚úÖ Know how to modify string literals and comments in the AST</li>
<li>‚úÖ Explore Go&rsquo;s AST (Abstract Syntax Tree) structure</li>
<li>‚úÖ Create custom source code transformations</li>
</ul>

<h2>üß† Background: How gofmt Works</h2>

<p>gofmt operates through these stages:</p>

<ol>
<li><strong>Parse</strong> ‚Üí Convert source code to AST (Abstract Syntax Tree)</li>
<li><strong>Transform</strong> ‚Üí Apply formatting rules to AST</li>
<li><strong>Print</strong> ‚Üí Convert modified AST back to formatted source code with specific indentation</li>
</ol>

<p>The indentation behavior is controlled by two key constants:</p>

<ul>
<li><strong><code>tabWidth</code></strong> ‚Üí Width of indentation (default: 8)</li>
<li><strong><code>printerMode</code></strong> ‚Üí Flags controlling spacing behavior:

<ul>
<li><code>printer.UseSpaces</code> ‚Üí Use spaces for padding</li>
<li><code>printer.TabIndent</code> ‚Üí Use tabs for indentation</li>
<li><code>printerNormalizeNumbers</code> ‚Üí Normalize number literals</li>
</ul></li>
</ul>

<h3>üå≥ AST Structure</h3>

<p>Go represents source code as a tree of nodes we are going to use here this two nodes:</p>

<ul>
<li><strong><code>*ast.BasicLit</code></strong> ‚Üí String literals, numbers, etc.</li>
<li><strong><code>*ast.Comment</code></strong> ‚Üí Comments in source code</li>
</ul>

<h2>üîç Step 1: Navigate to gofmt Source</h2>

<pre><code class="language-bash">cd go/src/cmd/gofmt
ls -la
</code></pre>

<p>Key files:</p>

<ul>
<li><strong><code>gofmt.go</code></strong> ‚Üí Main program logic and file processing</li>
<li><strong><code>simplify.go</code></strong> ‚Üí AST simplification transformations</li>
</ul>

<h2>üìè Step 2: Change Indentation to 4 Spaces</h2>

<p>Before adding custom transformations, let&rsquo;s change gofmt to use 4 spaces instead of tabs for indentation.</p>

<h3>Modify gofmt.go</h3>

<p><strong>Edit <code>go/src/cmd/gofmt/gofmt.go</code>:</strong></p>

<p>Find the constants around line 47 (look for the comment &ldquo;Keep these in sync with go/format/format.go&rdquo;):</p>

<pre><code class="language-go">const (
	tabWidth    = 8
	printerMode = printer.UseSpaces | printer.TabIndent | printerNormalizeNumbers
</code></pre>

<p>Change to:</p>

<pre><code class="language-go">const (
	tabWidth    = 4
	printerMode = printer.UseSpaces | printerNormalizeNumbers
</code></pre>

<p><strong>What changed:</strong></p>

<ul>
<li><strong><code>tabWidth</code></strong>: Changed from <code>8</code> to <code>4</code> (4 spaces per indentation level)</li>
<li><strong><code>printerMode</code></strong>: Removed <code>printer.TabIndent</code> flag (this removes tab characters and uses spaces only)</li>
</ul>

<h3>Modify go/format Package</h3>

<p>The <code>go/format</code> package also needs to be updated to keep behavior consistent.</p>

<p><strong>Edit <code>go/src/go/format/format.go</code>:</strong></p>

<p>Find the constants around line 28 (same comment as above):</p>

<pre><code class="language-go">const (
	tabWidth    = 8
	printerMode = printer.UseSpaces | printer.TabIndent | printerNormalizeNumbers
</code></pre>

<p>Change to:</p>

<pre><code class="language-go">const (
	tabWidth    = 4
	printerMode = printer.UseSpaces | printerNormalizeNumbers
</code></pre>

<h3>üîß Understanding the Changes</h3>

<ul>
<li><strong><code>tabWidth = 4</code></strong>: Each indentation level uses 4 spaces</li>
<li><strong>Removing <code>TabIndent</code></strong>: Without this flag, the printer uses only spaces (no tab characters)</li>
<li><strong><code>UseSpaces</code></strong>: Ensures spaces are used for padding and alignment</li>
<li><strong>Both files must match</strong>: gofmt and go/format must use the same settings for consistency</li>
</ul>

<h2>üî® Step 3: Rebuild and Test Indentation</h2>

<pre><code class="language-bash">cd ../../../  # back to go/src
./make.bash
</code></pre>

<p>Create a test file <code>indent_test.go</code>:</p>

<pre><code class="language-go">package main

import &quot;fmt&quot;

func main() {
	if true {
		for i := 0; i &lt; 10; i++ {
			fmt.Println(i)
		}
	}
}
</code></pre>

<p>Test the new indentation:</p>

<pre><code class="language-bash">cd ..  # to go/ directory
./bin/gofmt indent_test.go
</code></pre>

<p>Expected output (notice 4 spaces for each level):</p>

<pre><code class="language-go">package main

import &quot;fmt&quot;

func main() {
    if true {
        for i := 0; i &lt; 10; i++ {
            fmt.Println(i)
        }
    }
}
</code></pre>

<p>üéâ Each indentation level now uses 4 spaces instead of tabs!</p>

<h2>Step 4: Add Hello‚ÜíHelo Transformation</h2>

<p><strong>Edit <code>gofmt.go</code>:</strong></p>

<p>Add this transformation function around line 75 (after the <code>usage()</code> function):</p>

<pre><code class="language-go">// transformHelloToHelo walks the AST and replaces &quot;hello&quot; with &quot;helo&quot;
// in string literals and comments.
func transformHelloToHelo(file *ast.File) {
	ast.Inspect(file, func(n ast.Node) bool {
		switch node := n.(type) {
		case *ast.BasicLit:
			// Handle string literals
			if node.Kind == token.STRING {
				if strings.Contains(node.Value, &quot;hello&quot;) {
					node.Value = strings.ReplaceAll(node.Value, &quot;hello&quot;, &quot;helo&quot;)
				}
			}
		case *ast.Comment:
			// Handle comments
			if strings.Contains(node.Text, &quot;hello&quot;) {
				node.Text = strings.ReplaceAll(node.Text, &quot;hello&quot;, &quot;helo&quot;)
			}
		}
		return true // continue traversing
	})
}
</code></pre>

<h3>üîß Understanding the Code</h3>

<ul>
<li><strong><code>ast.Inspect()</code></strong> - Traverses all nodes in the AST</li>
<li><strong><code>*ast.BasicLit</code></strong> - Matches string literals</li>
<li><strong><code>node.Kind == token.STRING</code></strong> - Checks if it&rsquo;s a string (not a number)</li>
<li><strong><code>*ast.Comment</code></strong> - Matches comments</li>
<li><strong><code>strings.ReplaceAll()</code></strong> - Performs the replacement</li>
</ul>

<h2>Step 5: Integrate the Transformation</h2>

<p><strong>Still in <code>gofmt.go</code>:</strong></p>

<p>Find the <code>processFile</code> function around line 256. Look for:</p>

<pre><code class="language-go">	if *simplifyAST {
		simplify(file)
	}
</code></pre>

<p>Add our transformation right after:</p>

<pre><code class="language-go">	if *simplifyAST {
		simplify(file)
	}

	// Apply our custom hello‚Üíhelo transformation
	transformHelloToHelo(file)
</code></pre>

<h2>Step 6: Rebuild gofmt</h2>

<pre><code class="language-bash">cd ../../../  # back to go/src
./make.bash
</code></pre>

<h2>Step 7: Test Both Modifications Together</h2>

<p>Create a <code>hello_test.go</code> file:</p>

<pre><code class="language-go">package main

import &quot;fmt&quot;

func main() {
    // Say hello to everyone
    message := &quot;hello world&quot;
    greeting := &quot;Say hello!&quot;

    /* This is a hello comment block */
    fmt.Println(message)
    fmt.Println(greeting)

    // Another hello comment
    fmt.Printf(&quot;hello %s\n&quot;, &quot;Go&quot;)
}
</code></pre>

<pre><code class="language-bash">../go/bin/gofmt hello_test.go
</code></pre>

<p>Expected output (notice both 4-space indentation AND hello‚Üíhelo transformation):</p>

<pre><code class="language-go">package main

import &quot;fmt&quot;

func main() {
    // Say helo to everyone
    message := &quot;helo world&quot;
    greeting := &quot;Say helo!&quot;

    /* This is a helo comment block */
    fmt.Println(message)
    fmt.Println(greeting)

    // Another helo comment
    fmt.Printf(&quot;helo %s\n&quot;, &quot;Go&quot;)
}
</code></pre>

<p>üéâ Two changes applied:</p>

<ol>
<li>All &ldquo;hello&rdquo; instances are replaced with &ldquo;helo&rdquo;</li>
<li>Indentation uses 4 spaces instead of tabs</li>
</ol>

<h2>Step 8: Test In-Place Formatting</h2>

<pre><code class="language-bash"># Format and overwrite the file
../go/bin/gofmt -w hello_test.go

# Verify the changes
cat hello_test.go
</code></pre>

<p>The file is now permanently transformed with &ldquo;helo&rdquo; instead of &ldquo;hello&rdquo; and using 4-space indentation!</p>

<h2>Understanding What We Did</h2>

<ol>
<li><strong>Modified Printer Settings</strong>: Changed tabWidth and printerMode to use 4 spaces</li>
<li><strong>Synced Two Packages</strong>: Updated both gofmt and go/format for consistency</li>
<li><strong>Added AST Visitor</strong>: Created function to traverse and modify AST nodes</li>
<li><strong>Pattern Matching</strong>: Identified string literals and comments</li>
<li><strong>Text Replacement</strong>: Modified node values to replace &ldquo;hello&rdquo; with &ldquo;helo&rdquo;</li>
<li><strong>Integration</strong>: Called transformation during gofmt processing</li>
<li><strong>Testing</strong>: Verified both indentation and transformation changes</li>
</ol>

<h2>üéì What We Learned</h2>

<ul>
<li>üìè <strong>Printer Configuration</strong>: How gofmt controls indentation through tabWidth and printerMode</li>
<li>üîÑ <strong>Package Consistency</strong>: Why gofmt and go/format must stay in sync</li>
<li>üå≥ <strong>AST Manipulation</strong>: How to traverse and modify Go&rsquo;s Abstract Syntax Tree</li>
<li>üîß <strong>Tool Modification</strong>: How to extend existing Go tools with multiple changes</li>
<li>üîç <strong>Code Transformation</strong>: Implementing systematic source code changes</li>
<li>üèóÔ∏è <strong>Build Process</strong>: Rebuilding Go toolchain components</li>
<li>üß™ <strong>Testing</strong>: Verifying custom tool behavior</li>
</ul>

<h2>üí° Extension Ideas</h2>

<p>Try these additional modifications: üöÄ</p>

<ol>
<li>‚ûï Add a command-line flag to enable/disable the transformation</li>
<li>‚ûï Support multiple word replacements (hello‚Üíhelo, world‚Üíuniverse)</li>
<li>‚ûï Add case-sensitive option</li>
<li>‚ûï Only replace whole words (not substrings within words)</li>
<li>‚ûï Make tabWidth configurable via command-line flag</li>
<li>‚ûï Add option to switch between tabs and spaces</li>
</ol>

<p>Example flag addition:</p>

<pre><code class="language-go">var replaceHello = flag.Bool(&quot;helo&quot;, false, &quot;replace hello with helo&quot;)

// In processFile():
if *replaceHello {
    transformHelloToHelo(file)
}
</code></pre>

<h2>Cleanup</h2>

<p>To restore the original gofmt:</p>

<pre><code class="language-bash">cd go/src/cmd/gofmt
git checkout gofmt.go
cd ../go/format
git checkout format.go
cd ../../../src
./make.bash
</code></pre>

<h2>Summary</h2>

<p>You&rsquo;ve successfully modified gofmt in two powerful ways!</p>

<pre><code>Indentation:   tabs (8 width) ‚Üí 4 spaces
Transformation: &quot;hello world&quot;  ‚Üí &quot;helo world&quot;
                // Say hello    ‚Üí // Say helo

Changes:  tabWidth=4 + remove TabIndent flag
         + ast.Inspect() ‚Üí pattern match ‚Üí replace text
</code></pre>

<p>You now understand how tools like <code>gofmt</code>, <code>goimports</code>, and <code>go fix</code> work at both the printer and AST levels! ‚ö°üå≥</p>

<hr />

<p><em>Continue to <a href="06-ssa-power-of-two-detector.html">Exercise 6</a> or return to the <a href="index.html">main workshop</a></em></p>

        </article>

        <nav class="exercise-nav">
            
            <a href="04-compiler-inlining-parameters.html" class="nav-button">‚Üê Previous</a>
            
            
            <a href="06-ssa-power-of-two-detector.html" class="nav-button">Next: Exercise 6 ‚Üí</a>
            
        </nav>
    </div>

    <footer>
        <div class="container">
            <p>üöÄ Having fun with the Go Source Code</p>
            <p>Created by <strong>Jes√∫s Espino</strong></p>
            <div class="footer-links">
                <a href="https://github.com/jespino" target="_blank"><i class="fab fa-github"></i> GitHub</a>
                <a href="https://x.com/jespinog" target="_blank"><i class="fab fa-x-twitter"></i> @jespinog</a>
                <a href="https://linkedin.com/in/jesus-espino" target="_blank"><i class="fab fa-linkedin"></i> LinkedIn</a>
            </div>
        </div>
    </footer>
</body>
</html>
